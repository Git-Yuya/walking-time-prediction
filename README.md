# 連合学習を用いた歩行時間予測モデルの評価
　既存のナビアプリは、歩行速度を詳細に指定不可能、歩道の混雑度を考慮していないなどの要因により、各歩行者に正確な歩行時間を提供できていない。我々が普段使用するモバイル端末から取得できる位置情報や歩行速度などがある。それらのプライバシーデータを含むデータセットを連合学習して得られる歩行時間予測モデルは、多種多様なデータの特性を反映するため、各歩行者に適した正確な歩行時間を提供できる可能性がある。そこで、本プロジェクトでは歩行者マルチエージェントシミュレーションより取得した歩行に関わるデータセットを利用して、連合学習で歩行時間予測モデルがどの程度可能であるかを実験的に分析する。

## 課題と目的
**課題**  
- 連合学習は従来の1箇所に集約する機械学習に比べ、精度が劣る可能性

**目的**  
- 歩道状況や歩行速度を考慮した歩行時間予測モデルの構築
- 従来の1箇所に集約する機械学習と連合学習の予測精度の比較評価

## データセットの特徴量
- distance：進んだ距離 [m]
- width：歩道の幅 (1.0, 1.5, 2.0, 2.5, 3.0 m)
- speed：通常時の歩行速度 (0.8, 0.9, $\ldots$ , 1.7 m/s)
- crowd_level：混雑度 ("1", "2", "3", "4", "5")
- time：歩行時間 [s]

## 歩行時間予測モデル
- 機械学習モデル：線形回帰
- 前処理：One-Hot Encoding, 標準化
- 説明変数：歩道の幅 [m], 通常時の歩行速度 [m/s], 混雑度  
  width, speed, crowd_level_2, crowd_level_3, crowd_level_4, crowd_level_5
- 目的変数：1mあたりの歩行時間の実測値と理論値との誤差 [s/m]  
$\frac{1}{\text{distance}} \left( \text{time} - \frac{\text{distance}}{\text{speed}} \right) = \frac{\text{time}}{\text{distance}} - \frac{1}{\text{speed}}$

**例題)** 混雑度3、歩道の道幅1.5m、距離120mの歩道を通常時の歩行速度1.2m/sの人が歩く場合にかかる予測時間は？  
歩行時間予測モデルの出力までの流れは以下の通り。

<img src="https://github.com/Git-Yuya/walking-time-prediction/assets/84259422/110b87c4-5660-44f0-b22c-79b82ed97889" alt="歩行時間予測モデルの出力までの流れ" width="350">

以下の式より、120m歩くのに106.216秒かかると予測できる。ただし、1/1.2は歩行速度の逆数であり、1mあたりに何秒かかるかの理論値を表している。また、0.0518は歩行時間予測モデルの出力であり、1mあたりの実測値と理論値との誤差を表している。
$$(1/1.2 + 0.0518) \times 120 = 106.216$$ 




## 連合学習の評価
　データセットを訓練データ:テストデータ=7:3でランダムに分割する。評価指標は、1mあたりの歩行時間 [s/m]の平均絶対誤差 (Mean Absolute Error; MAE)を使用し、テストデータ全体と混雑度別に分けたテストデータで評価する。

- ランダムに分割

| クライアント数 | 収束ラウンド数 | 全体 | 混雑度1 | 混雑度2 |  混雑度3 |  混雑度4 |  混雑度5 |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 10 | 2 | 0.06191 | 0.03721 | 0.03657 | 0.05074 | 0.07378 | 0.11339 |
| 50 | 3 | 0.06202 | 0.03674 | 0.03618 | 0.04965 | 0.07596 | 0.11379 |
| 100 | 5 | 0.06236 | 0.03771 | 0.03695 | 0.05077 | 0.07371 | 0.11478 |
| 500 | 30 | 0.06248 | 0.03759 | 0.03683 | 0.05112 | 0.07384 | 0.11517 |
| 1000 | 100 | 0.06253 | 0.03801 | 0.03723 | 0.05101 | 0.07386 | 0.11464 |

<br>

- 歩行速度別に分割

| クライアント数 | 収束ラウンド数 | 全体 | 混雑度1 | 混雑度2 |  混雑度3 |  混雑度4 |  混雑度5 |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| 10 | 10 | 0.06257 | 0.03794 | 0.03723 | 0.04992 | 0.07491 | 0.11505 |
| 50 | 15 | 0.06276 | 0.03883 | 0.03785 | 0.05069 | 0.07396 | 0.11456 |
| 100 | 20 | 0.06282 | 0.03900 | 0.03810 | 0.05099 | 0.07374 | 0.11436 |
| 500 | 30 | 0.06283 | 0.03824 | 0.03741 | 0.05124 | 0.07485 | 0.11456 |
| 1000 | 75 | 0.06281 | 0.03806 | 0.03721 | 0.05113 | 0.07485 | 0.11497 |

## 実装
- 言語：
  <img src="https://img.shields.io/badge/-Python-3776AB.svg?logo=python&style=plastic">
- 機械学習ライブラリ：
  <img src="https://img.shields.io/badge/-PyTorch-EE4C2C.svg?logo=pytorch&style=plastic">
- 連合学習フレームワーク：
  <img src="https://flower.dev/_next/image/?url=%2F_next%2Fstatic%2Fmedia%2Fflower_white_border.c2012e70.png&w=640&q=75" width="18px" alt="Flower Website">
  <img src="https://img.shields.io/badge/-Flower-F2B705.svg?logo=&style=plastic">
- 統合開発環境：
  <img src="https://img.shields.io/badge/-Colab-F9AB00.svg?logo=google%20colab&style=plastic">

## 各ファイルの説明
- federated_learning.ipynb：連合学習を用いて歩行時間予測モデルを構築
- linear_regression.ipynb：2つの歩行時間予測モデルを評価
- multi_agent_simulation.ipynb：歩行者マルチエージェントシミュレーションから学習データセットを作成
- dataset.csv：multi_agent_simulation.ipynbで作成した学習データセット
